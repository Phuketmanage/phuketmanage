<% path = houses_path if action_name == 'new' %>
<% path = house_path(house.number) if action_name == 'edit' %>

<%= form_with(model: house, url: path, local: true, id: 'fileupload', data: { 'form-data' => (@s3_direct_post.fields), 'url' => @s3_direct_post.url, 'host' => URI.parse(@s3_direct_post.url).host }) do |form| %>
  <%= render 'shared/error_messages', object: form.object %>
        <!-- Redirect browsers with JavaScript disabled to the origin page -->
        <noscript
          ><input
            type="hidden"
            name="redirect"
            value="https://blueimp.github.io/jQuery-File-Upload/"
        /></noscript>
        <!-- The fileupload-buttonbar contains buttons to add/delete files and start/cancel the upload -->
        <div class="row fileupload-buttonbar">
          <div class="col-lg-7">
            <!-- The fileinput-button span is used to style the file input field as button -->
            <%= form.file_field :image, multiple: true %>
            <span class="btn btn-success fileinput-button">
              <i class="glyphicon glyphicon-plus"></i>
              <span>Add files...</span>
              <input type="file" name="files[]" multiple />
            </span>
            <button type="submit" class="btn btn-primary start">
              <i class="glyphicon glyphicon-upload"></i>
              <span>Start upload</span>
            </button>
            <button type="reset" class="btn btn-warning cancel">
              <i class="glyphicon glyphicon-ban-circle"></i>
              <span>Cancel upload</span>
            </button>
            <button type="button" class="btn btn-danger delete">
              <i class="glyphicon glyphicon-trash"></i>
              <span>Delete selected</span>
            </button>
            <input type="checkbox" class="toggle" />
            <!-- The global file processing state -->
            <span class="fileupload-process"></span>
          </div>
          <!-- The global progress state -->
          <div class="col-lg-5 fileupload-progress fade">
            <!-- The global progress bar -->
            <div
              class="progress progress-striped active"
              role="progressbar"
              aria-valuemin="0"
              aria-valuemax="100"
            >
              <div
                class="progress-bar progress-bar-success"
                style="width:0%;"
              ></div>
            </div>
            <!-- The extended global progress state -->
            <div class="progress-extended">&nbsp;</div>
          </div>
        </div>
        <!-- The table listing the files available for upload/download -->
        <table role="presentation" class="table table-striped">
          <tbody class="files"></tbody>
        </table>
<% end %>

<%= form_with(model: house, url: path, local: true, class: 'directUpload', data: { 'form-data' => (@s3_direct_post.fields), 'url' => @s3_direct_post.url, 'host' => URI.parse(@s3_direct_post.url).host }) do |form| %>
  <%= render 'shared/error_messages', object: form.object %>

  <div class="field">
    <%= form.label :image %><br>
    <%= form.file_field :image, multiple: true, id: '_fileupload' %>
  </div>
  <!-- The table listing the files available for upload/download -->
  <table role="presentation" class="table table-striped">
    <tbody class="files"></tbody>
  </table>

<% end %>

<!-- The blueimp Gallery widget -->
    <div
      id="blueimp-gallery"
      class="blueimp-gallery blueimp-gallery-controls"
      data-filter=":even"
    >
      <div class="slides"></div>
      <h3 class="title"></h3>
      <a class="prev">‹</a>
      <a class="next">›</a>
      <a class="close">×</a>
      <a class="play-pause"></a>
      <ol class="indicator"></ol>
    </div>
    <!-- The template to display files available for upload -->
    <script id="template-upload" type="text/x-tmpl">
      {% for (var i=0, file; file=o.files[i]; i++) { %}
          <tr class="template-upload fade">
              <td>
                  <span class="preview"></span>
              </td>
              <td>
                  {% if (window.innerWidth > 480 || !o.options.loadImageFileTypes.test(file.type)) { %}
                      <p class="name">{%=file.name%}</p>
                  {% } %}
                  <strong class="error text-danger"></strong>
              </td>
              <td>
                  <p class="size">Processing...</p>
                  <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div class="progress-bar progress-bar-success" style="width:0%;"></div></div>
              </td>
              <td>
                  {% if (!o.options.autoUpload && o.options.edit && o.options.loadImageFileTypes.test(file.type)) { %}
                    <button class="btn btn-success edit" data-index="{%=i%}" disabled>
                        <i class="glyphicon glyphicon-edit"></i>
                        <span>Edit</span>
                    </button>
                  {% } %}
                  {% if (!i && !o.options.autoUpload) { %}
                      <button class="btn btn-primary start" disabled>
                          <i class="glyphicon glyphicon-upload"></i>
                          <span>Start</span>
                      </button>
                  {% } %}
                  {% if (!i) { %}
                      <button class="btn btn-warning cancel">
                          <i class="glyphicon glyphicon-ban-circle"></i>
                          <span>Cancel</span>
                      </button>
                  {% } %}
              </td>
          </tr>
      {% } %}
    </script>
    <!-- The template to display files available for download -->
    <script id="template-download" type="text/x-tmpl">
      {% for (var i=0, file; file=o.files[i]; i++) { %}
          <tr class="template-download fade">
              <td>
                  <span class="preview">
                      {% if (file.thumbnailUrl) { %}
                          <a href="{%=file.url%}" title="{%=file.name%}" download="{%=file.name%}" data-gallery><img src="{%=file.thumbnailUrl%}"></a>
                      {% } %}
                  </span>
              </td>
              <td>
                  {% if (window.innerWidth > 480 || !file.thumbnailUrl) { %}
                      <p class="name">
                          {% if (file.url) { %}
                              <a href="{%=file.url%}" title="{%=file.name%}" download="{%=file.name%}" {%=file.thumbnailUrl?'data-gallery':''%}>{%=file.name%}</a>
                          {% } else { %}
                              <span>{%=file.name%}</span>
                          {% } %}
                      </p>
                  {% } %}
                  {% if (file.error) { %}
                      <div><span class="label label-danger">Error</span> {%=file.error%}</div>
                  {% } %}
              </td>
              <td>
                  <span class="size">{%=o.formatFileSize(file.size)%}</span>
              </td>
              <td>
                  {% if (file.deleteUrl) { %}
                      <button class="btn btn-danger delete" data-type="{%=file.deleteType%}" data-url="{%=file.deleteUrl%}"{% if (file.deleteWithCredentials) { %} data-xhr-fields='{"withCredentials":true}'{% } %}>
                          <i class="glyphicon glyphicon-trash"></i>
                          <span>Delete</span>
                      </button>
                      <input type="checkbox" name="delete" value="1" class="toggle">
                  {% } else { %}
                      <button class="btn btn-warning cancel">
                          <i class="glyphicon glyphicon-ban-circle"></i>
                          <span>Cancel</span>
                      </button>
                  {% } %}
              </td>
          </tr>
      {% } %}
    </script>

<%= form_with(model: house, url: path, local: true, class: 'directUpload', data: { 'form-data' => (@s3_direct_post.fields), 'url' => @s3_direct_post.url, 'host' => URI.parse(@s3_direct_post.url).host }) do |form| %>
  <%= render 'shared/error_messages', object: form.object %>

  <div class="field">
    <%= form.label :image %><br>
    <%= form.file_field :image, multiple: true %>
  </div>



  <%= image_tag house.image if house.image %>

  <div class="row form-group">
    <%#= form.label :owner_id, class: 'col-md-1 col-form-label' %>
    <div class="col-md-2">
      <%= form.select :owner_id,
            @owners.order(:name, :surname).all.map {|o| ["#{o.name} #{o.surname}", o.id]},
                      { prompt: 'Select owner' }, { class: "form-control"  } %>
    </div>
    <%#= form.label :type_id, class: 'col-md-1 col-form-label' %>
    <div class="col-md-2">
      <%= form.select :type_id,
            @types.order(:name_en).all.map {|t| [t.send("name_#{I18n.locale}"), t.id]},
                      { prompt: 'Select type' }, { class: "form-control"  } %>
    </div>
    <%#= form.label :code, class: 'col-md-1 col-form-label' %>
    <div class="col-md-2">
      <%= form.text_field :code, class: 'form-control', placeholder: 'Code' %>
    </div>

  </div>

  <div class="shadow-sm mb-2 p-2 bg-light rounded">
    <strong>English</strong>
    <hr>
    <div class="row">
      <div class="col-6 form-group">
        <%= form.label :title_en %>
        <%= form.text_field :title_en, class: 'form-control' %>
      </div>
    </div>
    <div class="row">
      <div class="col form-group">
        <%= form.label :description_en %>
        <%= form.text_area :description_en, class: 'form-control', rows: 6 %>
      </div>
    </div>
  </div>

  <div class="shadow-sm mb-2 p-2 bg-light rounded">
    <strong>Русский</strong>
    <hr>
    <div class="row">
      <div class="col-6 form-group">
      <%= form.label 'Заголовок' %>
      <%= form.text_field :title_ru, class: 'form-control'%>
      </div>
    </div>
    <div class="row">
      <div class="col form-group">
        <%= form.label 'Описание' %>
        <%= form.text_area :description_ru, class: 'form-control', rows: 6  %>
      </div>
    </div>
  </div>
  <div class="shadow-sm mb-2 p-2 bg-light rounded">
    <strong>General details</strong>
    <hr>
    <div class="row">
      <div class="col-6 form-group">
        <%= form.label :address %>
        <%= form.text_field :address, class: 'form-control' %>
      </div>
      <div class="col-6 form-group">
        <%= form.label :google_map %>
        <%= form.text_field :google_map, class: 'form-control' %>
      </div>
    </div>
    <div class="row">
      <div class="col-1 form-group">
        <%= form.label :rooms %>
        <%= form.number_field :rooms, class: 'form-control' %>
      </div>
      <div class="col-1 form-group">
        <%= form.label :bathrooms %>
        <%= form.number_field :bathrooms, class: 'form-control' %>
      </div>
      <div class="col-1 form-group">
        <%= form.label :size %>
        <%= form.number_field :size, class: 'form-control' %>
      </div>
      <div class="col-1 form-group">
        <%= form.label :plot_size %>
        <%= form.number_field :plot_size, class: 'form-control' %>
      </div>
    </div>
    <div class="row">
      <div class="col-1 form-group">
        <div class="form-check">
          <%= form.check_box :pool, { class: 'form-check-input',
                                  id: 'pool_check_box' } %>
          <%= form.label :pool, {     class: 'form-check-label',
                                  for: 'pool_check_box' } %>
        </div>
      </div>
      <div class="col-2 form-group">
        <div class="form-check">
          <%= form.check_box :communal_pool, { class: 'form-check-input',
                                  id: 'communal_pool_check_box' } %>
          <%= form.label :communal_pool, {     class: 'form-check-label',
                                  for: 'communal_pool_check_box' } %>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-2 form-group">
        <%= form.label 'Pool size, sq m' %>
        <%= form.number_field :pool_size, class: 'form-control' %>
      </div>
    </div>
    <div class="row">
      <div class="col-1 form-group">
        <div class="form-check">
          <%= form.check_box :parking, { class: 'form-check-input',
                                  id: 'parking_check_box' } %>
          <%= form.label :parking, {     class: 'form-check-label',
                                  for: 'parking_check_box' } %>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-2 form-group">
        <%= form.label 'Parking size, how many cars' %>
        <%= form.number_field :parking_size, class: 'form-control' %>
      </div>
    </div>
  </div>

  <div class="shadow-sm mb-2 p-2 bg-light rounded">
    <strong>Employees:</strong>
    <hr>

    <%= form.collection_check_boxes :employee_ids, Employee.all, :id, :type_with_name do |e| %>
        <div class="form-check form-check-inline">
          <%= e.check_box(class: "form-check-input") %>
          <%= e.label(class: "form-check-label" ) %>
        </div>
    <% end %>

    <strong>Service provided</strong>

    <div class="form-check form-check-inline">
      <%= form.check_box :rental, { class: 'form-check-input',
                              id: 'rental_check_box' } %>
      <%= form.label :rental, {     class: 'form-check-label',
                              for: 'rental_check_box' } %>
    </div>
    <div class="form-check form-check-inline">
      <%= form.check_box :maintenance, { class: 'form-check-input',
                              id: 'maintenance_check_box' } %>
      <%= form.label :maintenance, {     class: 'form-check-label',
                              for: 'maintenance_check_box' } %>
    </div>
    <div class="form-check form-check-inline">
      <%= form.check_box :outsource_cleaning, { class: 'form-check-input',
                              id: 'outsource_cleaning_check_box' } %>
      <%= form.label :outsource_cleaning, {     class: 'form-check-label',
                              for: 'outsource_cleaning_check_box' } %>
    </div>
    <div class="form-check form-check-inline">
      <%= form.check_box :outsource_linen, { class: 'form-check-input',
                              id: 'outsource_linen_check_box' } %>
      <%= form.label :outsource_linen, {     class: 'form-check-label',
                              for: 'outsource_linen_check_box' } %>
    </div>

  </div>
  <div class="form-check mb-2">
    <%= form.check_box :unavailable, { class: 'form-check-input',
                            id: 'unavailable_check_box' } %>
    <%= form.label :unavailable, {     class: 'form-check-label',
                            for: 'unavailable_check_box' } %>
  </div>

  <div class="actions">
    <%= form.submit 'Save House', class: 'btn btn-primary' %>
    <%= link_to 'Back', houses_path, class: 'btn btn-secondary' %>
  </div>
<% end %>

<div class="shadow-sm mb-2 p-2 bg-light rounded mt-2">
  <strong>Connections</strong>
  <hr>
  <% @connections.each do |c| %>
    <p>
      <%= "#{c.source.name}: #{c.link}" %>
      <%= link_to 'Destroy', connection_path(c.id), method: :delete, data: { confirm: 'Are you sure?' } %>
    </p>
  <% end %>
  <%= form_with(model: connection, url: connections_path(hid: house.number), local: true) do |form| %>
    <% if connection.errors.any? %>
      <%= render 'shared/error_messages', object: form.object %>
    <% end %>
    <div class="row">
      <div class="col-md-2 ">
        <%= form.select :source_id,
              @sources.all.map {|s| [s.name, s.id]},
                        { prompt: 'Select source' }, { class: "form-control",  } %>
      </div>

      <div class="col-md-8 form-group">
        <%= form.text_field :link,  placeholder: "Link",
                                    class: 'form-control' %>
      </div>
      <div class="col-md-2 actions">
        <%= form.submit 'Save Connection', class: 'btn btn-primary' %>
      </div>

    </div>
  <% end %>

</div>
