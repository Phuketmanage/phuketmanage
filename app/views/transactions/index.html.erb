<h1>
  Balance
  <%= 'compnay view' if @view == 'company' %>
  <%= 'owner view' if @view == 'owner' %>
  <%= 'accounting view' if @view == 'accounting' %>
</h1>

<div class="mb-2 d-print-none">
  <%= form_with(url: transactions_path, method: :get, local: true, class: 'form-inline') do |form| %>
        <%= form.select :user_id,
              User.with_role(['Owner']).map {|u| [u.name, u.id]},
              { include_blank: 'Select owner', selected: params[:user_id] },
              class: "form-control mb-2 mr-sm-2" %>
        <%= form.submit 'Company view', class: "btn btn-primary mb-2 mr-2" %>
        <%= form.submit 'Owner view', class: "btn btn-primary mb-2 mr-2" %>
        <%= form.submit 'Accounting view', class: "btn btn-primary mb-2 mr-2" %>

  <% end %>
</div>
<%= link_to 'New Transaction', new_transaction_path %>
<% if @view == 'company' %>
  <table class='table'>
    <thead>
      <tr>
        <th>Date</th>
        <th>Debit</th>
        <th>Credit</th>
        <th>Balance</th>
        <th>Type</th>
        <th>House</th>
        <th>Comment</th>
        <th>Comment inner</th>
        <th colspan="3"></th>
        <th>Debit</th>
        <th>Credit</th>
      </tr>
    </thead>
    <tbody>
      <% de_co_sum = 0 %>
      <% cr_co_sum = 0 %>
      <% @transactions.each do |t| %>
        <tr>
          <td><%= t.date.strftime('%d.%m.%Y') %></td>
          <% de_co = t.balances.sum(:debit) %>
          <% cr_co = t.balances.sum(:credit) %>
          <% de_co_sum += de_co %>
          <% cr_co_sum += cr_co %>
          <td><%= de_co if de_co > 0 %></td>
          <td><%= cr_co if cr_co > 0 %></td>
          <td>balance</td>
          <td><%= t.type.name_en %></td>
          <td><%= t.house.code if t.house %></td>
          <td><%= t.comment_en %></td>
          <td><%= t.comment_inner %></td>
          <td><%= link_to 'Show', t %></td>
          <td><%= link_to 'Edit', edit_transaction_path(t) %></td>
          <td><%= link_to 'Destroy', t, method: :delete, data: { confirm: 'Are you sure?' } %></td>
          <% debit = t.balance_outs.sum(:debit) %>
          <% credit = t.balance_outs.sum(:credit) %>
          <td><%= debit if debit > 0%></td>
          <td><%= credit if credit > 0 %></td>
        </tr>
      <% end %>
      <tr>
        <td clas='text-right font-weight-bold'>Total:</td>
        <td class="font-weight-bold"><%= de_co_sum %></td>
        <td class="font-weight-bold"><%= cr_co_sum %></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
      </tr>
    </tbody>
  </table>
<% elsif @view == 'owner' %>
  <table class='table'>
    <thead>
      <tr>
        <th>Date</th>
        <th>Debit</th>
        <th>Credit</th>
        <th>Balance</th>
        <th>Type</th>
        <th>House</th>
        <th>Comment</th>
        <th>Comment inner</th>
        <th colspan="3"></th>
      </tr>
    </thead>

    <tbody>
      <% de_ow_sum = 0 %>
      <% cr_ow_sum = 0 %>
      <% @transactions.each do |t| %>
        <tr>
          <td><%= t.date.strftime('%d.%m.%Y') %></td>
          <% de_ow = t.balance_outs.sum(:debit) %>
          <% cr_ow = t.balance_outs.sum(:credit) %>
          <% de_ow_sum += de_ow %>
          <% cr_ow_sum += cr_ow %>
          <td><%= de_ow - cr_ow if de_ow > 0 %></td>
          <td><%= cr_ow unless de_ow > 0 %></td>
          <td>balance</td>
          <td><%= t.type.name_en %></td>
          <td><%= t.house.code if t.house %></td>
          <td><%= t.comment_en %></td>
          <td><%= t.comment_inner %></td>
          <td><%= link_to 'Show', t %></td>
          <td><%= link_to 'Edit', edit_transaction_path(t) %></td>
          <td><%= link_to 'Destroy', t, method: :delete, data: { confirm: 'Are you sure?' } %></td>
        </tr>
      <% end %>
      <tr>
        <td clas='text-right font-weight-bold'>Total:</td>
        <td class="font-weight-bold"><%= de_ow_sum %></td>
        <td class="font-weight-bold"><%= cr_ow_sum %></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
      </tr>
    </tbody>
  </table>
<% elsif @view == 'accounting' %>
  <table class='table'>
    <thead>
      <tr>
        <th>Date</th>
        <th>Ref No</th>
        <th>Debit</th>
        <th>Credit</th>
        <th>Balance</th>
        <th width='50%'>Comment</th>
        <th colspan="3"></th>
      </tr>
    </thead>

    <tbody>
      <% de_ow_sum = 0 %>
      <% cr_ow_sum = 0 %>
      <% de_co_sum = 0 %>
      <% @transactions.each do |t| %>
        <% de_ow = t.balance_outs.sum(:debit) %>
        <% cr_ow = t.balance_outs.sum(:credit) %>
        <% de_co = t.balances.sum(:debit) %>
        <% cr_ow_personal = cr_ow - de_co %>
        <% de_ow_sum += de_ow %>
        <% cr_ow_sum += cr_ow_personal %>
        <% de_co_sum += de_co %>
        <% next if (cr_ow - de_co + de_ow ) == 0 %>
        <tr>
          <td><%= t.date.strftime('%d.%m.%Y') %></td>
          <th></th>
          <td><%= de_ow if de_ow > 0 %></td>
          <td><%= cr_ow_personal if cr_ow_personal > 0 %></td>
          <td>balance</td>
          <td><%= t.comment_en %></td>
        </tr>
      <% end %>
      <% if de_co_sum > 0 %>
        <% cr_ow_sum += de_co_sum %>
        <tr>
          <td><%= Time.zone.now.in_time_zone('Bangkok').end_of_month.to_date.strftime('%d.%m.%Y') %></td>
          <td></td>
          <td></td>
          <td><%= de_co_sum %></td>
          <td></td>
          <td>Maintenance <%= link_to 'Show invoice details', '#', class: 'd-print-none', data: { toggle: "modal", target: "#modal_invoice" } %></td>
        </tr>
      <% end %>
      <tr>
        <td></td>
        <td class='text-right font-weight-bold'>Total:</td>
        <td class="font-weight-bold"><%= de_ow_sum %></td>
        <td class="font-weight-bold"><%= cr_ow_sum %></td>
        <td></td>
        <td></td>
      </tr>
    </tbody>
  </table>
<% end %>

<% if @view == 'accounting' && de_co_sum > 0 %>
  <!-- Modal: end of month invoice -->
  <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" id='modal_invoice'>
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <table class='table'>
          <thead>
            <tr>
              <th>Date</th>
              <th>Comment</th>
              <th>Before VAT</th>
              <th>With VAT</th>
            </tr>
          </thead>

          <tbody>
            <% de_co_sum = 0 %>
            <% vat_sum = 0 %>
            <% de_co_bvat_sum = 0 %>
            <% de_co_wvat_sum = 0 %>
            <% @transactions.each do |t| %>
              <% de_co = t.balances.sum(:debit) %>
              <% next unless de_co > 0 %>
              <% de_co_sum += de_co %>
              <% vat = de_co.to_f*0.07 %>
              <% de_co_bvat = de_co-vat %>
              <% de_co_wvat = de_co %>
              <% de_co_bvat_sum += de_co_bvat %>
              <% de_co_wvat_sum += de_co_wvat %>
              <% vat_sum += vat %>
              <tr>
                <td><%= t.date.strftime('%d.%m.%Y') %></td>
                <td><%= t.comment_en %></td>
                <td><%= de_co_bvat.round(2) %></td>
                <td><%= de_co_wvat %></td>
              </tr>
            <% end %>
            <tr>
              <td></td>
              <td class='text-right font-weight-bold'>
                Sub total:<br />
                VAT(7%):<br />
                Total:<br />
              </td>
              <td class="font-weight-bold">
                <%= de_co_bvat_sum.round(2) %><br />
                <%= vat_sum.round(2) %><br />
                <%= (de_co_bvat_sum+vat_sum).round(2) %>
                </td>
              <td class="font-weight-bold">
                <br /><br /><%= de_co_sum %>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% end %>
