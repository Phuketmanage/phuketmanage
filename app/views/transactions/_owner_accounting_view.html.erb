<table class='table'>
  <thead>
    <tr>
      <th width="120px">Date</th>
      <th width="120px">Ref No</th>
      <th class="text-right" width="120px">Debit</th>
      <th class="text-right" width="120px">Credit</th>
      <th width='50%'>Comment</th>
      <th colspan="3"></th>
    </tr>
  </thead>

  <tbody>
    <% de_ow_sum = 0 %>
    <% cr_ow_sum = 0 %>
    <% de_co_sum = 0 %>
    <% transactions.each do |t| %>
      <% de_ow = t.balance_outs.sum(:debit) %>
      <% cr_ow = t.balance_outs.sum(:credit) %>
      <% de_co = t.balances.sum(:debit) %>
      <% cr_co = t.balances.sum(:credit) %>
      <% cr_ow_personal = cr_ow - de_co  %>
      <% de_ow_sum += de_ow %>
      <% cr_ow_sum += cr_ow_personal %>
      <% de_co_sum += de_co %>
      <% next if (cr_ow - de_co + de_ow ) == 0 %>
      <tr id="trsc_<%= t.id %>_row">
        <td><%= t.date.strftime('%d.%m.%Y') %></td>
        <th></th>
        <td class='de_ow_cell text-right'><%= number_to_currency(de_ow, precision: 2, unit: '') if de_ow > 0 %></td>
        <td class='cr_ow_cell text-right'><%= number_to_currency(cr_ow_personal, precision: 2, unit: '') if cr_ow_personal > 0 %></td>
        <td><%= t.comment_en %></td>
      </tr>
    <% end %>
    <% if de_co_sum > 0 %>
      <% cr_ow_sum += de_co_sum %>
      <tr>
        <td><%= Time.zone.now.in_time_zone('Bangkok').end_of_month.to_date.strftime('%d.%m.%Y') %></td>
        <td></td>
        <td></td>
        <td class='text-right' id='company_maintenance'><%= number_to_currency(de_co_sum, precision: 2, unit: '') %></td>
        <td>Maintenance <%= link_to 'Show invoice details', '#', class: 'd-print-none', data: { toggle: "modal", target: "#modal_invoice" } %></td>
      </tr>
    <% end %>
    <tr>
      <td></td>
      <td class='text-right font-weight-bold text-right'>Total:</td>
      <td class="font-weight-bold text-right" id='de_ow_sum'><%= number_to_currency(de_ow_sum, precision: 2, unit: '') %></td>
      <td class="font-weight-bold text-right" id='cr_ow_sum'><%= number_to_currency(cr_ow_sum, precision: 2, unit: '') %></td>
      <td class="font-weight-bold" id="ow_balance"><%= number_to_currency(de_ow_sum - cr_ow_sum, precision: 2, unit: '') %></td>
    </tr>
  </tbody>
</table>

<% if de_co_sum > 0 %>
  <!-- Modal: end of month invoice -->
  <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" id='modal_invoice'>
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <table class='table'>
          <thead>
            <tr>
              <th>Date</th>
              <th>Comment</th>
              <th>Before VAT</th>
              <th>With VAT</th>
            </tr>
          </thead>

          <tbody>
            <% de_co_sum = 0 %>
            <% vat_sum = 0 %>
            <% de_co_bvat_sum = 0 %>
            <% de_co_wvat_sum = 0 %>
            <% transactions.each do |t| %>
              <% de_co = t.balances.sum(:debit) %>
              <% next unless de_co > 0 %>
              <% de_co_sum += de_co %>
              <% vat = de_co.to_f*0.07 %>
              <% de_co_bvat = de_co-vat %>
              <% de_co_wvat = de_co %>
              <% de_co_bvat_sum += de_co_bvat %>
              <% de_co_wvat_sum += de_co_wvat %>
              <% vat_sum += vat %>
              <tr id="trsc_<%= t.id %>_iv_row">
                <td><%= t.date.strftime('%d.%m.%Y') %></td>
                <td><%= t.comment_en %></td>
                <td class="iv_price_bvat_cell text-right"><%= number_to_currency(de_co_bvat.round(2), precision: 2, unit: '') %></td>
                <td class="iv_price_cell text-right"><%= number_to_currency(de_co_wvat, precision: 2, unit: '') %></td>
              </tr>
            <% end %>
            <tr>
              <td></td>
              <td class='text-right font-weight-bold text-right'>
                Sub total:<br />
                VAT(7%):<br />
                Total:<br />
              </td>
              <td class="font-weight-bold text-right">
                <%= number_to_currency(de_co_bvat_sum.round(2), precision: 2, unit: '') %><br />
                <%= number_to_currency(vat_sum.round(2), precision: 2, unit: '') %><br />
                <span id="iv_de_co_sum"><%= number_to_currency((de_co_bvat_sum+vat_sum).round(2), precision: 2, unit: '') %></span>
                </td>
              <td class="font-weight-bold text-right" id='iv_de_co_sum_2'>
                <br /><br /><%= number_to_currency(de_co_sum, precision: 2, unit: '') %>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% end %>
