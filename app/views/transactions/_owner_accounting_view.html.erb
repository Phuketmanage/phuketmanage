<div class="d-none d-print-block">
<% owner = User.find(params[:view_user_id]) %>
Balance of: <%= "#{owner.name} #{owner.surname}" %><br />
Address:
<% owner.houses.each do |h| %>
  - <%= h.address %><br />
<% end %>
</div>

<table id="balabce_table" class='table table-striped table-bordered table-sm bg-white table-responsive-lg'>
  <thead>
    <tr>
      <th width="80px">Date</th>
      <th width="320px">Ref No</th>
      <th class="text-right" width="105px">Debit</th>
      <th class="text-right" width="105px">Credit</th>
      <th class="text-right" width="105px">Balance</td>
      <th>Comment</th>
      <th colspan="3"><span class='d-print-none'>Actions</span></th>
    </tr>
  </thead>

  <tbody>
    <% de_ow_sum = 0 %>
    <% cr_ow_sum = 0 %>
    <% de_co_sum = 0 %>
    <% de_ow_hidden_sum = 0 %>
    <% cr_ow_hidden_sum = 0 %>
    <% de_ow_prev_sum = 0 %>
    <% cr_ow_prev_sum = 0 %>
    <% balance_sum = 0 %>
    <% if transactions_before.any? %>
      <% de_ow_prev_sum = transactions_before.where(hidden: false).joins(:balance_outs).sum('balance_outs.debit') %>
      <% cr_ow_prev_sum = transactions_before.where(hidden: false).joins(:balance_outs).sum('balance_outs.credit') %>
      <% balance_sum += de_ow_prev_sum - cr_ow_prev_sum %>
      <tr>
        <td></td>
        <td></td>
        <td class="text-right" id="de_ow_prev_sum">
          <%= number_to_currency(de_ow_prev_sum - cr_ow_prev_sum, precision: 2, unit: '') if de_ow_prev_sum > cr_ow_prev_sum %>
        </td>
        <td class="text-right" id="cr_ow_prev_sum">
          <%= number_to_currency(cr_ow_prev_sum - de_ow_prev_sum, precision: 2, unit: '') if cr_ow_prev_sum > de_ow_prev_sum %>
        </td>
        <td class="text-right" id="ow_prev_balance"><%= number_to_currency(balance_sum, precision: 2, unit: '') %></td>
        <td>Balance from previous period</td>
        <td></td>
    <% end %>
    <% transactions.each do |t| %>
      <% de_ow = t.balance_outs.sum(:debit) %>
      <% cr_ow = t.balance_outs.sum(:credit) %>
      <% de_co = t.balances.sum(:debit) %>
      <% cr_co = t.balances.sum(:credit) %>
      <% if t.hidden %>
        <% de_ow_hidden_sum += de_ow %>
        <% cr_ow_hidden_sum += cr_ow %>
      <% end %>
      <% cr_ow_personal = cr_ow - de_co  %>
      <% unless t.hidden %>
        <% de_ow_sum += de_ow %>
        <% cr_ow_sum += cr_ow_personal %>
        <% de_co_sum += de_co %>
        <% balance_sum += de_ow - cr_ow_personal %>
      <% end %>
      <% next if (cr_ow - de_co + de_ow ) == 0 %>
      <tr id="trsc_<%= t.id %>_row"
        <%= 'class=hidden_row style=display:none;' if t.hidden %>
        <%= 'class=for_acc_row' if t.for_acc %>>
        <td><%= t.date.strftime('%d.%m.%Y') %></td>
        <td><small><%= t.ref_no %></small></td>
        <td class='de_ow_cell text-right'><%= number_to_currency(de_ow, precision: 2, unit: '') if de_ow > 0 %></td>
        <td class='cr_ow_cell text-right'><%= number_to_currency(cr_ow_personal, precision: 2, unit: '') if cr_ow_personal > 0 %></td>
        <td class='balance_sum_cell text-right'><%= number_to_currency(balance_sum, precision: 2, unit: '') if !t.hidden %></td>
        <td><%= t.comment_en %></td>
        <td>
          <div class="d-print-none">
            <% if current_user.role?(['Accounting', 'Manager']) && t.date > (Date.today-30.days).beginning_of_month %>
              <%= link_to 'Edit', edit_transaction_path(t) %>
            <% end %>
            <% if current_user.role?(['Accounting', 'Manager']) && t.date > Date.today-1.day %>
              <%= link_to 'Destroy', t, method: :delete, data: { confirm: 'Are you sure?' } %>
            <% end %>
            <% if current_user.role?('Admin') %>
              <%= link_to 'Edit', edit_transaction_path(t) %>
              <%= link_to 'Destroy', t, method: :delete, data: { confirm: 'Are you sure?' } %>
            <% end %>
          </div>
        </td>
      </tr>
    <% end %>
    <% if de_co_sum > 0 %>
      <% cr_ow_sum += de_co_sum %>
      <tr>
        <td><%= @to.to_date.strftime('%d.%m.%Y') %></td>
        <td><small>
          <%= transactions.joins(:balances).where('balances.debit > 0').pluck('balances.ref_no').uniq.join(', ') %></small>
        </td>
        <td></td>
        <td class='text-right' id='company_maintenance'><%= number_to_currency(de_co_sum, precision: 2, unit: '') %></td>
        <td class='balance_sum_cell text-right'><%= number_to_currency(balance_sum - de_co_sum, precision: 2, unit: '') %></td>
        <td>Maintenance <%= link_to 'Show invoice details', '#', class: 'd-print-none', data: { toggle: "modal", target: "#modal_invoice" } %></td>
        <td></td>
      </tr>
    <% end %>
    <tfoot>
      <tr>
        <td></td>
        <td class='font-weight-bold text-right d-print-none'>Total:</td>
        <td class="font-weight-bold text-right d-print-none">
          <div id='de_ow_sum'>
            <%= number_to_currency(de_ow_prev_sum + de_ow_sum, precision: 2, unit: '') %>
          </div>
          <% if de_ow_hidden_sum > 0 %>
            <div class="text-muted" id='de_ow_hidden_sum'>
              <%= number_to_currency(de_ow_hidden_sum, precision: 2, unit: '') %>
            </div>
            <div class="text-muted" id='de_ow_sum_and_hidden'>
              <%= number_to_currency(de_ow_prev_sum + de_ow_sum + de_ow_hidden_sum, precision: 2, unit: '') %>
            </div>
          <% end %>
        </td>
        <td class="font-weight-bold text-right d-print-none">
          <div id='cr_ow_sum'>
            <%= number_to_currency(cr_ow_prev_sum + cr_ow_sum, precision: 2, unit: '') %>
          </div>
          <% if cr_ow_hidden_sum > 0 %>
            <div class="text-muted" id='cr_ow_hidden_sum'>
              <%= number_to_currency(cr_ow_hidden_sum, precision: 2, unit: '') %>
            </div>
            <div class="text-muted" id='cr_ow_sum_and_hidden'>
              <%= number_to_currency(cr_ow_prev_sum + cr_ow_sum + cr_ow_hidden_sum, precision: 2, unit: '') %>
            </div>
          <% end %>
        </td>
        <td class="font-weight-bold text-right d-print-none">
          <div id="ow_balance">
            <%= number_to_currency(de_ow_prev_sum + de_ow_sum - cr_ow_prev_sum - cr_ow_sum, precision: 2, unit: '') %>
          </div>
          <% if de_ow_hidden_sum > 0 || cr_ow_hidden_sum > 0 %>
            <div class="text-muted" id="ow_hidden_balance d-print-none">
              <%= number_to_currency(de_ow_hidden_sum - cr_ow_hidden_sum, precision: 2, unit: '') %>
            </div>
            <div class="text-muted d-print-none" id="ow_balance_and_hidden">
              <%= number_to_currency((de_ow_prev_sum + de_ow_sum + de_ow_hidden_sum) - (cr_ow_prev_sum + cr_ow_sum + cr_ow_hidden_sum), precision: 2, unit: '') %>
            </div>
          <% end %>
        </td>
        <td></td>
        <td>
          <% if de_ow_hidden_sum > 0 || cr_ow_hidden_sum > 0 %>
            <%= link_to 'Show hidden', '#', id: 'link_show_hidden', class: 'text-muted d-print-none' %>
          <% end %>
        </td>
      </tr>
    </tfoot>
  </tbody>
</table>

<% if de_co_sum > 0 %>
  <!-- Modal: end of month invoice -->
  <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" id='modal_invoice'>
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <table class='table table-striped table-bordered bg-white table-sm table-responsive-lg'>
          <thead>
            <tr>
              <th>Date</th>
              <th>Comment</th>
              <th>Before VAT</th>
              <th>With VAT</th>
            </tr>
          </thead>

          <tbody>
            <% de_co_sum = 0 %>
            <% vat_sum = 0 %>
            <% de_co_bvat_sum = 0 %>
            <% de_co_wvat_sum = 0 %>
            <% transactions.each do |t| %>
              <% next if t.hidden %>
              <% de_co = t.balances.sum(:debit) %>
              <% next unless de_co > 0 %>
              <% de_co_sum += de_co %>
              <% vat = de_co.to_f*7/107 %>
              <% de_co_bvat = de_co-vat %>
              <% de_co_wvat = de_co %>
              <% de_co_bvat_sum += de_co_bvat %>
              <% de_co_wvat_sum += de_co_wvat %>
              <% vat_sum += vat %>
              <tr id="trsc_<%= t.id %>_iv_row">
                <td><%= t.date.strftime('%d.%m.%Y') %></td>
                <td><%= t.comment_en %></td>
                <td class="iv_price_bvat_cell text-right"><%= number_to_currency(de_co_bvat.round(2), precision: 2, unit: '') %></td>
                <td class="iv_price_cell text-right"><%= number_to_currency(de_co_wvat, precision: 2, unit: '') %></td>
              </tr>
            <% end %>

            <tfoot>
              <tr>
                <td></td>
                <td class='text-right font-weight-bold text-right'>
                  Sub total:<br />
                  VAT(7%):<br />
                  Total:<br />
                </td>
                <td class="font-weight-bold text-right">
                  <span id='de_co_bvat_sum'>
                    <%= number_to_currency(de_co_bvat_sum.round(2), precision: 2, unit: '') %>
                  </span>
                  <br />
                  <span id='vat_sum'>
                    <%= number_to_currency(vat_sum.round(2), precision: 2, unit: '') %>
                  </span>
                  <br />
                  <span id="iv_de_co_sum"><%= number_to_currency((de_co_bvat_sum+vat_sum).round(2), precision: 2, unit: '') %></span>
                  </td>
                <td class="font-weight-bold text-right" id='iv_de_co_sum_2'>
                  <br /><br /><%= number_to_currency(de_co_sum, precision: 2, unit: '') %>
                </td>
              </tr>
            </tfoot>
          </tbody>
        </table>
        <%= form_with url: update_invoice_ref_path, local: true, class: 'form-inline' do |f| %>
          <div class='m-2'><%= label_tag :ref_no %></div>
          <%= text_field_tag :ref_no,nil, class: "form-control m-2" %>
          <%= submit_tag 'Save', class: "btn btn-primary m-2" %>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
