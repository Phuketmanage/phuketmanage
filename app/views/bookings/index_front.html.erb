<h1><%= t('bookings') %> <%= @house.code if @house %> (<%= @bookings.count %>)</h1>
<%= form_with(url: bookings_front_path, method: :get, local: true, class: 'form-inline') do |form| %>
      <%= date_field_tag :from, {}, value: @from, class: "form-control mb-2 mr-sm-2" %>
      <%= date_field_tag :to, {}, value: @to, class: "form-control mb-2 mr-sm-2" %>
      <% if !@one_house %>
        <%= select_tag :hid,
              options_for_select(current_user.houses.where(unavailable: false).order(:code).map                   {|h| [h.code, h.number]}, params[:hid]),
                { include_blank: 'All houses', class: "form-control mb-2 mr-sm-2" } %>
      <% end %>
      <%= submit_tag t('show'), class: "btn btn-primary mb-2 mr-2" %>
      <%= link_to t('drop_filter'), bookings_front_path, class: 'btn btn-secondary mb-2 mr-2'  %>
      <%#= link_to t('timeline'), bookings_timeline_path(period: 45), class: 'btn btn-info mb-2 mr-2'  %>
<% end %>

<% if @error %>
  <div class="alert alert-warning" role="alert">
    <%= @error %>
  </div>
<% elsif @bookings.empty? %>
  <div class="alert alert-warning" role="alert">
    No bookings
  </div>
<% else %>
  <table class="table table-striped table-bordered table-sm table-responsive-lg">
    <thead>
      <tr>
        <% if !@one_house %>
          <th width="60px"><%= t('house') %></th>
        <% end %>
        <th width="120px"><%= t('start') %></th>
        <th width="120px"><%= t('finish') %></th>
        <th width="60px"><%= t('days') %></th>
        <th width="120px" class='text-right'><%= t('profit') %></th>
        <th width="120px" class='text-right'><%= t('to_balance') %></th>
        <th><%= t('comment') %></th>
      </tr>
    </thead>

    <tbody>
      <% nett_sum = 0 %>
      <% profit_sum = 0 %>
      <% @bookings.each do |booking| %>
        <% profit = 0 %>
        <% if booking.transactions.any? %>
          <% income = booking.transactions.joins(:balance_outs).sum(:debit) %>
          <% comm = booking.transactions.joins(:balance_outs).sum(:credit) %>
          <% profit = income - comm %>
        <% end %>
        <% nett_sum += booking.nett %>
        <% profit_sum += profit %>
        <tr>
          <% if !@one_house %>
            <td><%= !@house ? link_to(booking.house.code, bookings_front_path(hid: booking.house.number)) : booking.house.code %></td>
          <% end %>
          <td><%= booking.start.strftime('%d.%m.%Y') %></td>
          <td><%= booking.finish.strftime('%d.%m.%Y') %></td>
          <td><%= (booking.finish - booking.start).to_i %></td>
          <td class='text-right'><%= number_to_currency(booking.nett, precision: 0, unit: '') %></td>
          <td class='text-right'><%= number_to_currency(profit, precision: 0, unit: '') %></td>
          <td>
            <%= booking.comment_owner %>
            <% if booking.transactions.any? %>
              <%= '|' if booking.comment_owner %>
              <%= t('added_to_balance') %>: <%= booking.transactions.order(:date).map{|t| "#{t.date.strftime('%d.%m.%Y')}"}.join ', ' %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
    <tfoot>
      <tr>
        <% if !@one_house %>
          <td></td>
        <% end %>
        <td></td>
        <td></td>
        <td class='font-weight-bold text-right'><%= t('total') %>:</td>
        <td class='font-weight-bold text-right'><%= number_to_currency(nett_sum, precision: 0, unit: '') %></td>
        <td class='font-weight-bold text-right'><%= number_to_currency(profit_sum, precision: 0, unit: '') %></td>
        <td class='font-weight-bold'><%= number_to_currency(nett_sum - profit_sum, precision: 0, unit: '') %></td>
      </tr>
    </tfoot>
  </table>
<% end %>
