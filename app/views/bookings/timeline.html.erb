<h1>Timeline</h1>

<div class="timeline_container">
  <!-- Header open -->
  <div class="timeline_header">
    <div class="house">
      House
    </div>
    <% @timeline[:days].times do |i| %>
      <% date = @timeline[:start]+i.days %>
      <% day = date.day %>
      <% month_end = date.end_of_month.day %>
      <% if (i == 0 && day > 1) || day == 1 %>
        <div class='month_date'> <!-- Open month -->
        <% month_days = month_end - day + 1 %>
        <% over_days = (date + month_days.days - @timeline[:start]+@timeline[:days].days).to_i %>
        <% if over_days > 0  %>
          <% month_days -= over_days %>
        <% end %>
        <% width = 30*month_days %>
        <div class='month' style="width: <%= width %>px;"><%= date.strftime('%B') %></div>
      <% end %>
      <div class="date">
        <%= day %>
      </div>
      <% if day == month_end %>
        </div> <!-- Close month -->
      <% end %>
    <% end %>
  </div>
  <!-- Header close -->

  <% @timeline[:data].each do |h| %>
    <div>
      <div class="house">
        <%= House.find_by(number: h[:hid]).code %>
      </div>
      <% last_position = 0 %>
      <% i = 1 %>
      <% h[:bookings].each do |b| %>

        <% if b[:position] - 1 > last_position %>
          <% (b[:position] - 1 - last_position).times do %>
            <div class="cell free">
            &nbsp;
            </div>
          <% end %>
        <% end %>
        <% width = 30*b[:length] %>
        <div class="cell booked" style="width: <%= width %>px;">
          #<%= Booking.find_by(number: b[:number]).number %>
        </div>
        <% last_position = b[:position] + b[:length] - 1 %>
        <!-- Empty cells after last booking -->
        <% if i == h[:bookings].size && last_position < @timeline[:days] %>
          <%= h[:bookings].size %>
          <% (@timeline[:days]-last_position).times do %>
            <div class="cell free">
              &nbsp;
            </div>
          <% end %>
        <% end %>
        <% i += 1 %>
      <% end %>
      <!-- Emtry cells if no bookings -->
      <% if h[:bookings].empty? %>
        <% @timeline[:days].times do %>
          <div class="cell free">
            &nbsp;
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>
